---
export const prerender = false; // Changed to false to handle dynamic payment data

import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

// Page handles session_id via JavaScript

---

<BaseLayout 
  title="Payment Confirmed - Boost SEO"
  description="Your payment has been processed successfully. Your traffic boost campaign will start soon."
>
  <Header />
  
  <main class="min-h-screen bg-gray-50 py-20">
    <div class="container">
      <div class="max-w-2xl mx-auto text-center">
        <!-- Success Icon -->
        <div class="w-20 h-20 bg-green-500 text-white rounded-full flex items-center justify-center mx-auto mb-8">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        
        <!-- Success Message -->
        <div class="mb-12">
          <h1 class="text-headline brutalist-text mb-6 text-gray-900">
            PAYMENT<br />
            CONFIRMED!
          </h1>
          <p class="text-lg text-gray-600 mb-6">
            Thank you for choosing Boost SEO! Your payment has been processed successfully.
          </p>
        </div>
        
        <!-- Project Details Form -->
        <div id="project-details-section" class="mb-8">
          <!-- Will be populated by JavaScript after fetching session data -->
        </div>
        
        <!-- Next Steps (shown after form submission) -->
        <div id="next-steps-section" class="bg-white border border-gray-200 p-8 rounded-lg mb-8" style="display: none;">
          <div class="text-mono text-sm text-gray-500 mb-4">[ NEXT STEPS ]</div>
          <h2 class="text-xl font-bold mb-6 text-gray-900">What happens now?</h2>
          
          <div class="space-y-6 text-left">
            <div class="flex items-start">
              <div class="w-8 h-8 bg-orange-500 text-white text-mono font-bold flex items-center justify-center text-sm mr-4 mt-1">
                1
              </div>
              <div>
                <div class="font-semibold mb-1">Project Analysis</div>
                <div class="text-sm text-gray-600">
                  Our team will analyze your site and keywords to optimize the campaign strategy.
                </div>
              </div>
            </div>
            
            <div class="flex items-start">
              <div class="w-8 h-8 bg-orange-500 text-white text-mono font-bold flex items-center justify-center text-sm mr-4 mt-1">
                2
              </div>
              <div>
                <div class="font-semibold mb-1">Campaign Start</div>
                <div class="text-sm text-gray-600">
                  The boost campaign will begin within 24 hours after we receive your project data.
                </div>
              </div>
            </div>
            
            <div class="flex items-start">
              <div class="w-8 h-8 bg-orange-500 text-white text-mono font-bold flex items-center justify-center text-sm mr-4 mt-1">
                3
              </div>
              <div>
                <div class="font-semibold mb-1">Monitoring</div>
                <div class="text-sm text-gray-600">
                  You will receive daily reports on your ranking progress during the campaign.
                </div>
              </div>
            </div>
            
            <div class="flex items-start">
              <div class="w-8 h-8 bg-orange-500 text-white text-mono font-bold flex items-center justify-center text-sm mr-4 mt-1">
                4
              </div>
              <div>
                <div class="font-semibold mb-1">Final Report</div>
                <div class="text-sm text-gray-600">
                  At the end of the campaign, you will receive a complete report with all achieved results.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Contact Information -->
        <div class="bg-gray-900 text-white p-6 rounded-lg mb-8">
          <div class="text-mono text-sm text-gray-400 mb-2">[ SUPPORT ]</div>
          <h3 class="text-lg font-bold mb-4">Need Help?</h3>
          <p class="text-gray-300 mb-4">
            Our team is available to answer any questions about your campaign.
          </p>
          <a 
            href="mailto:contact@boostseo.co.nz" 
            class="inline-flex items-center text-orange-400 hover:text-orange-300 font-medium"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            contact@boostseo.co.nz
          </a>
        </div>
        
        <!-- Back to Home -->
        <div class="flex justify-center">
          <a href="/" class="btn btn-outline">
            BACK TO SITE
          </a>
        </div>
      </div>
    </div>
  </main>
  
  <Footer />
  
  <!-- Initialize dataLayer for GTM -->
  <script>
    // Extend window interface for dataLayer
    declare global {
      interface Window {
        dataLayer: any[];
      }
    }
    
    window.dataLayer = window.dataLayer || [];
    
    function gtag(...args: any[]) {
      window.dataLayer.push(args);
    }
  </script>
  
  <!-- Fetch session data and render form -->
  <script>    
    document.addEventListener('DOMContentLoaded', async function() {
      const projectDetailsSection = document.getElementById('project-details-section');
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session_id');
      
      if (!sessionId) {
        // No session ID, show fallback message
        if (projectDetailsSection) {
          projectDetailsSection.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 p-6 rounded-lg text-center">
            <h3 class="text-lg font-semibold text-yellow-800 mb-2">
              Payment data not found
            </h3>
            <p class="text-yellow-700 mb-4">
              Please contact our support to set up your campaign.
            </p>
            <a href="mailto:contact@boostseo.co.nz" class="btn btn-primary">
              CONTACT US
            </a>
          </div>
          `;
        }
        return;
      }

      try {
        // Fetch session data from our API
        const response = await fetch(`/api/get-session?session_id=${sessionId}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error('Failed to fetch session data:', errorData);
          throw new Error(`Failed to fetch session data: ${errorData.error || response.statusText}`);
        }
        
        const paymentData = await response.json();
        console.log('Payment data received:', paymentData);
        
        // Store payment data globally for form submission
        (window as any).paymentData = paymentData;
        
        // Push purchase data to dataLayer for GTM tracking
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: 'purchase_completed',
          event_category: 'ecommerce',
          event_label: 'boost_seo_purchase',
          purchase_data: {
            transaction_id: paymentData.paymentId || sessionId,
            session_id: sessionId,
            customer_email: paymentData.customerEmail,
            plan_name: paymentData.planName,
            plan_price: paymentData.planPrice,
            currency: 'NZD',
            timestamp: new Date().toISOString(),
            page_type: 'success_page'
          },
          // Enhanced ecommerce data for GA4
          ecommerce: {
            transaction_id: paymentData.paymentId || sessionId,
            value: paymentData.planPrice,
            currency: 'NZD',
            items: [{
              item_id: paymentData.planName.toLowerCase().replace(/\s+/g, '_'),
              item_name: paymentData.planName,
              item_category: 'seo_boost',
              price: paymentData.planPrice,
              quantity: 1
            }]
          }
        });
        
        // Render the form
        if (projectDetailsSection) {
          projectDetailsSection.innerHTML = `
          <div class="bg-white border border-gray-200 p-8 rounded-lg">
            <div class="text-mono text-sm text-gray-500 mb-4">[ PROJECT DETAILS ]</div>
            <h2 class="text-xl font-bold mb-6 text-gray-900">
              Configure Your Boost Campaign
            </h2>
            
            <!-- Payment Summary -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-8">
              <div class="text-sm font-medium text-gray-500 mb-3">Payment Summary:</div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Email:</span>
                  <span class="font-medium">${paymentData.customerEmail}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Plan:</span>
                  <span class="font-medium">${paymentData.planName}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Amount:</span>
                  <span class="font-medium text-green-600">NZ$ ${paymentData.planPrice.toFixed(2)}</span>
                </div>
              </div>
            </div>

            <!-- Form -->
            <form id="project-form" class="space-y-6">
              <div>
                <label for="websiteUrl" class="block text-sm font-medium text-gray-700 mb-2">
                  Your website URL *
                </label>
                <input
                  type="url"
                  id="websiteUrl"
                  name="websiteUrl"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="https://yoursite.co.nz"
                  required
                />
                <p class="mt-1 text-xs text-gray-500">
                  Include the protocol (https://) and complete address
                </p>
              </div>

              <div>
                <label for="mainKeyword" class="block text-sm font-medium text-gray-700 mb-2">
                  Main keyword *
                </label>
                <input
                  type="text"
                  id="mainKeyword"
                  name="mainKeyword"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="e.g: business consulting"
                  required
                />
                <p class="mt-1 text-xs text-gray-500">
                  The most important keyword you want to rank for
                </p>
              </div>

              ${paymentData.planName !== '1 Day' ? `
              <div>
                <label for="keyword2" class="block text-sm font-medium text-gray-700 mb-2">
                  Keyword 2 <span class="text-gray-500">(optional)</span>
                </label>
                <input
                  type="text"
                  id="keyword2"
                  name="keyword2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="e.g: financial consulting"
                />
              </div>

              <div>
                <label for="keyword3" class="block text-sm font-medium text-gray-700 mb-2">
                  Keyword 3 <span class="text-gray-500">(optional)</span>
                </label>
                <input
                  type="text"
                  id="keyword3"
                  name="keyword3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="e.g: strategic consulting"
                />
                <p class="mt-1 text-xs text-gray-500">
                  Your ${paymentData.planName} plan includes up to 3 keywords
                </p>
              </div>
              ` : `
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="text-sm text-blue-800">
                  <strong>1 Day Plan:</strong> Includes only 1 main keyword
                </div>
              </div>
              `}

              <div>
                <label class="flex items-start space-x-3">
                  <input
                    type="checkbox"
                    name="agreeToStart"
                    class="mt-1 w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
                    required
                  />
                  <span class="text-sm text-gray-600 leading-relaxed">
                    I authorize the start of the traffic boost campaign with the information provided above. 
                    I understand that the campaign will begin within 24 hours after submitting this form.
                  </span>
                </label>
              </div>

              <div class="flex justify-center pt-4">
                <button
                  type="submit"
                  id="submit-btn"
                  class="btn btn-primary px-8 py-3"
                >
                  START MY CAMPAIGN
                </button>
              </div>
            </form>
          </div>
        `;
        
        // Handle form submission
        const form = document.getElementById('project-form');
        if (form) {
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = 'Sending...';
            }
            
            const formData = new FormData(form as HTMLFormElement);
            
            const submitData = {
              // Payment info
              'Email': paymentData.customerEmail,
              'Plan': paymentData.planName,
              'Amount Paid': paymentData.planPrice,
              'Payment ID': paymentData.paymentId,
              'Payment Date': new Date().toISOString(),
              
              // Project details
              'Website URL': formData.get('websiteUrl'),
              'Keyword 1': formData.get('mainKeyword'),
              'Keyword 2': formData.get('keyword2') || '',
              'Keyword 3': formData.get('keyword3') || '',
              'Total Keywords': [formData.get('mainKeyword'), formData.get('keyword2'), formData.get('keyword3')].filter(k => k).length,
              
              // Status
              'Campaign Status': 'Ready for Execution',
              'Submission Date': new Date().toISOString()
            };
            
            try {
              console.log('Submitting data:', submitData);
              
              const response = await fetch('/api/submit-project', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(submitData)
              });
              
              if (response.ok) {
                // Push form completion data to dataLayer for GTM tracking
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                  event: 'project_form_completed',
                  event_category: 'form',
                  event_label: 'boost_seo_project_setup',
                  form_data: {
                    transaction_id: paymentData.paymentId || sessionId,
                    session_id: sessionId,
                    customer_email: paymentData.customerEmail,
                    plan_name: paymentData.planName,
                    plan_price: paymentData.planPrice,
                    website_url: formData.get('websiteUrl'),
                    main_keyword: formData.get('mainKeyword'),
                    keyword_2: formData.get('keyword2') || '',
                    keyword_3: formData.get('keyword3') || '',
                    total_keywords: [formData.get('mainKeyword'), formData.get('keyword2'), formData.get('keyword3')].filter(k => k).length,
                    timestamp: new Date().toISOString(),
                    campaign_status: 'ready_for_execution'
                  }
                });
                
                // Show success message
                if (projectDetailsSection) {
                  projectDetailsSection.innerHTML = `
                  <div class="bg-white border border-gray-200 p-8 rounded-lg">
                    <div class="text-center">
                      <div class="w-16 h-16 bg-green-500 text-white rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                      </div>
                      
                      <h3 class="text-xl font-bold text-gray-900 mb-4">
                        Data Sent Successfully!
                      </h3>
                      
                      <p class="text-gray-600 mb-6">
                        We have received all your project information. Our team will start your campaign within 24 hours.
                      </p>
                      
                      <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <div class="text-sm font-medium text-orange-800 mb-2">
                          ðŸ“§ You will receive a confirmation email shortly
                        </div>
                        <div class="text-sm text-orange-700">
                          With the detailed schedule of your campaign and tracking information.
                        </div>
                      </div>
                    </div>
                  </div>
                  `;
                }
                
                // Show next steps section
                const nextStepsSection = document.getElementById('next-steps-section');
                if (nextStepsSection) {
                  nextStepsSection.style.display = 'block';
                }
              } else {
                const errorData = await response.json();
                console.error('Server error response:', errorData);
                throw new Error(errorData.error || `Server returned ${response.status}: ${response.statusText}`);
              }
            } catch (error) {
              console.error('Error:', error);
              const errorMessage = error instanceof Error ? error.message : 'Unknown error';
              alert('Error sending data: ' + errorMessage + '. Please try again or contact support.');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'START MY CAMPAIGN';
              }
            }
          });
        }
        }
        
      } catch (error) {
        console.error('Error loading payment data:', error);
        const errorMessage = error instanceof Error ? error.message : 'Unknown error';
        if (projectDetailsSection) {
          projectDetailsSection.innerHTML = `
            <div class="bg-red-50 border border-red-200 p-6 rounded-lg text-center">
              <h3 class="text-lg font-semibold text-red-800 mb-2">
                Error loading payment data
              </h3>
              <p class="text-red-700 mb-4">
                There was a problem verifying your payment: ${errorMessage}
              </p>
              <p class="text-red-600 text-sm mb-4">
                Session ID: ${sessionId || 'N/A'}
              </p>
              <a href="mailto:contact@boostseo.co.nz" class="btn btn-primary">
                CONTACT US
              </a>
            </div>
          `;
        }
      }
    });
  </script>
</BaseLayout>
